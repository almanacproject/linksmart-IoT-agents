<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-GB" lang="en-GB">
<head>
<meta charset="UTF-8" />
<title>WebSocket chat | ALMANAC</title>
<meta name="robots" content="noindex, nofollow" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font: 13px "Arial", "Helvetica", sans-serif; }
form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
#messages { list-style-type: none; margin: 0 0 45px 0; padding: 0; }
li { padding: 5px 10px; }
li:nth-child(odd) { background: #eee; }
</style>
</head>

<body>
	<ul id="messages"></ul>
	<form action="" onsubmit="return chat(this);">
		<input id="m" autocomplete="off" />
		<button>Send</button>
	</form>

<script>
"use strict";

var messages = document.getElementById('messages'),
		messageBox = document.getElementById('m');

function append(text) {
	while (messages.childNodes.length > 128) {
		messages.removeChild(messages.firstChild);
	}
	var li = document.createElement('li');
	li.textContent = text;
	messages.appendChild(li);
	li = null;
	window.scrollTo(0, document.body.scrollHeight);
	messageBox.focus();
}

try {
	var webSocket = new WebSocket('ws://' + location.host + '/ws/chat');

	webSocket.onerror = function (event) {
			append('Error: ' + JSON.stringify(event));
		};

	webSocket.onopen = function () {
			append('Connected');
		};

	webSocket.onclose = function () {
			append('Closed');
			webSocket = null;
		};

	webSocket.onmessage = function (event) {
			append('Message: ' + event.data);
		};
} catch (ex) {
	append('Exception: ' + ex.message);
}

function chat(form) {
	if (webSocket) {
		webSocket.send(JSON.stringify({
			text: form.m.value,
		}));
	} else {
		append('WebSocket not ready!');
	}
	form.m.value = '';
	return false;
}
</script>
</body>
</html>
