# SCRAL - Smart City Resource Adaptation Layer##
The Smart City Resource Adaptation Layer (SCRAL) provides a REST - based uniform and transparent access to physical devices, capillary networks, systems and services for monitoring and actuation in a
Smart City context.

Peculiar device functionalities are uniformed, abstracted and mapped to a well-known  set  of  functions  and  primitives  complying  with  (device)  models  handled  in  the  semantic framework of the ALMANAC platform. Moreover, due to its nature of interface between the ALMANAC platform and the real world, the SCRAL offers primitives for applying access-control, data-validation and role-based policies on field-level data sources. While typical SCRAL instances are distributed near to  physical  devices,  meaning  that more  than  one  SCRAL  instance  is  usually  adopted  in  a  single ALMANAC P
latform Instance (PI), at least one cloud instance is typically available in a PI to support connection  of  smart  devices,  i.e.,  of  devices  able  to  natively  exchange  data  conforming  to  the
ALMANAC data model. In such a case, the main SCRAL duty is to enforce access rights, perform data validation and support needed provisioning primitives.

## Installation How-To
The SCRAL is delivered as a simple web application that can be run on any Servlet Container. Additionally a set of test scripts are provided to allow checking and diagnosing the component both in the post-installation and in the runtime operation phases.

Currently the SCRAL has been extensively tested in 2 Servlet containers:

* [Apache Tomcat](http://tomcat.apache.org/) (v7.0)
* [Jetty](http://eclipse.org/jetty/)

Assuming that the reference environment for the SCRAL installation is a Ubuntu-based server (but only for the sake of demonstrating installation, any platform capable of hosting a Servlet Container shall be suitable), the full installation process is as follows:

#### Apache Tomcat set-up

Download and install Apache Tomcat using the distribution package manager:

```
sudo apt-get install tomcat7
```

### SCRAL set-up

Download the latest SCRAL version either from the ALMANAC git repository or from [BSCW](https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44033744/SCRAL).

```
wget https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44033744/SCRAL
```

Assuming that you downloaded  the SCRAL war file in the ```\home\almanac``` folder, move the war file to the right place on the Servlet Container (i.e., Tomcat)

```
sudo mv ./scral.war /var/lib/tomcat7/webapps/
```
At this point Tomcat should automatically deploy the war file into a published context named after the war file name, i.e., scral

Check if the SCRAL is running by looking at the Tomcat7 logs

```
less /var/log/tomcat7/catalina.out
```

you should see logging lines generated by the SCRAL. To further check the actual working, open-up a browser and go to the ```http://localhost:8080/scral/devices``` address. You should see a variable (possibly empty) lis of device ids.

#### SCRAL configuration
To configure the SCRAL for interfacing devices and gateways, the provided SCRAL configuration file shall be edited according to the peculiarities of the current installation. The scral location file is located in the ```WEB-INF/classes``` folder of the corresponding web application.

```
cd /var/lib/tomcat7/webapps/scral/WEB-INF/classes/applicationContext-pwal.xml
```

And the file is structured as follows:

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean id="PWAL" class="it.ismb.pertlab.pwal.PwalImpl">
    <constructor-arg>
      <list value-type="it.ismb.pertlab.pwal.api.devices.interfaces.DevicesManager">
        <!-- <ref bean="bluetoothManager"/> -->
        <!-- <ref bean="serialManager"/> -->
        <!-- <ref bean="SmartSantanderManager" />-->
        <ref bean="xivelyManager"/>
        <!-- <ref bean="m2mManager" /> -->
        <!-- <ref bean="WasteBinSimulatorManager" /> -->
        <!-- <ref bean="PhilipsHueManager" /> -->
        <!-- <ref bean="IESmartBinDriver" /> -->
      </list>
    </constructor-arg>
  </bean>
  <!-- 	<bean id="SmartSantanderManager" class="it.ismb.pertlab.pwal.smartsantander.manager.SmartSantanderManager"  depends-on="mqttPusher" /> -->

  <!-- 	<bean id="serialManager" class="it.ismb.pertlab.pwal.serialmanager.SerialManager" depends-on="mqttPusher">
    <constructor-arg>
      <map> -->
        <!-- List of sensors that can be provided by this serial device -->
        <!-- key=sensor_id value=device_type -->
        <!-- <entry key="idFillLevelSensor" value="it.ismb.pertlab.pwal.manager.serial.device.FillLevelSensorFit" /> -->
        <!-- <entry key="idFlowSensor" value="it.ismb.pertlab.pwal.manager.serial.device.FlowMeterSensorFit"	/>  -->
        <!-- <entry key="idWaterPump" value="it.ismb.pertlab.pwal.manager.serial.device.WaterPumpFit" />  -->
      <!-- 			</map>
    </constructor-arg>
    <constructor-arg value="COM5" />
  </bean> -->
  <bean id="xivelyManager" class="it.ismb.pertlab.pwal.xivelymanager.XivelyManager" depends-on="mqttPusher"/>
  <!-- <bean id="m2mManager" class="it.ismb.pertlab.pwal.etsi_m2m_manager.EtsiM2MManager" depends-on="mqttPusher">
    <constructor-arg value="http://m2mtilab.dtdns.net/etsi/almanac" />
  </bean>  -->
  <bean id="mqttPusher" class="it.ismb.pertlab.pwal.pusher.mqtt.MqttPusher">
    <constructor-arg value="tcp://130.192.86.227:1883" />
    <!-- <constructor-arg value="tcp://localhost:1883" /> -->
    <constructor-arg value="localscral3"></constructor-arg>
    <constructor-arg value="scral.trn.federation1.almanac-project.eu"></constructor-arg>
  </bean>
  <!-- <bean id="WasteBinSimulatorManager"
    class="it.ismb.pertlab.pwal.wastebinsimulator.WasteBinSimulatorManager"> -->
    <!-- <constructor-arg value="1000" />  -->
    <!-- <constructor-arg value="turin_waste.jsonld" />
    <constructor-arg value="600000"/>
  </bean> -->
  <!-- <bean id="ResourceCatalogConnector"  class="it.ismb.pertlab.pwal.resourcecatalog.connector.ResourceCatalogConnector">
    <constructor-arg value="http://pertscrum.polito.it:44441/"/>
    <constructor-arg value="http://almanac-showcase.ismb.it:8080/connectors.rest/"/>
  </bean>-->
  <bean id="IESmartBinDriver" class="it.ismb.pertlab.pwal.smartbindriver.IESmartBinDriver">
    <constructor-arg value="https://secure.smartbin.com:443/metricsAPIv24/MetricsAPIv24"/>
    <constructor-arg value="5000"/>
    <constructor-arg value="xxxxxxxxxxxxxxxxxxxxxx"/>
    <constructor-arg value="xxxxxxxxxxxxxxxxxxxxxx"/>
    </bean>
</beans>
```

As can easily be noticed, device and technology managers are activated by:

1. Listing the corresponding  reference in the bean entry with id equal to ```PWAL```
2. Defining a suitable ```<bean>...</bean>``` entry for providing the needed initialization parameters, e.g., the number of fake bins to generate for the ```WasteBinSimulatorManager``` or the api keys for the ```IESmartBinDriver```

Once updated the configuration, the SCRAL should be restarted. This can be done either by stopping and restarting the corresponding context on the servlet container, or, more easily, by restarting the container:

```
sudo service tomcat7 restart
```

At this point the SCRAL shall be active and serving the confugured devices / technologies.

### SCRAL GUI
The scral GUI is a standalone static web application (plain html and javascript) and can be hosted on any web server. In a minimal installation case, the Servlet Container itself is typically sufficient to host the gui.

##### Jekyll

The GUI is built using the [Jekyll](http://jekyllrb.com/) tool for easier composition and configuration. In our Ubuntu-based example Jeckyll can be installed with the following instructions:

```
sudo apt-get install ruby ruby-dev make gcc nodejs
sudo gem install jekyll --no-rdoc --no-ri
```

once completed the installation, it can be checked by running

```
jekyll -v
```

which should display the version of the just installed Jekyll

#### SCRAL GUI compilation

Download the latest SCRAL-GUI source files, either from the ALMANAC git repostory or from [BSCW](https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44039215/SCRAL-GUI.tar)

```
wget https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44039215/SCRAL-GUI.tar
```

Extract the file in a suitable folder.

```
tar -xvfz scral.tar.gz
```

enter the folder and update, if needed, the gui settings.

```
cd scral-gui
sudo nano _congfig.yml
```

whose content is reported below.

```
# Site settings
title: SCRAL
email: pwalscrum@ismb.it
description: Smart City Resources Adaptation Layer
baseurl: "" # the subpath of your site, e.g. /blog/
url: "http://yourdomain.com" # the base hostname & protocol for your site
rest_endpoint: http://127.0.0.1:8080/connectors.rest
#rest_endpoint: http://almanac-showcase.ismb.it:8000/iot360/scral
mqtt_broker: almanac-showcase.ismb.it
#mqtt_broker: localhost
mqtt_port: 8000
#mqtt_websocket_endpoint: /
mqtt_websocket_endpoint: /mosquitto



# Build settings
markdown: redcarpet
redcarpet:
extensions: ["hard_wrap", "no_intra_emphasis", "fenced_code_blocks", "autolink", "tables", "with_toc_data", "strikethrough", "superscript"]
highlighter: pygments
permalink: /:categories/:year/:title.html
```

Once configured correctly the web site, run Jekyll to build the runtime (final) version of the site:

```
jekyll build
```

and copy the files generated in the ```_site``` folder to the destination folder (served by a Web Server, e.g., the Servlet Container used for running the SCRAL)

```
sudo cp -R /home/almanac/scral-gui/_site/* /var/lib/tomcat7/webapps/scral-gui/
```
### Support and Diagnosis scripts
The SCRAL is accompanied by several support and diognostic scripts in Python which allow to:

1. Feed the "simulated" devices based on xively (also offering REST-APIs for some of them)
2. Check the messages received through a selected MQTT message broker, on a specified topic

#### Simulated devices based on Xively
Two types of simulated devices based on Xively are available: Fill-Level and Temperature sensors (they might actually be part of the Same "real device", although this might generate some mis-representation in the OGC SensorThings API format)

They are respectively handled by the:

* ```fill_level_simulator.py``` python script (and dependencies)
* ```temperature_simulator.py``` python script (and dependencies)

the latter offers a REST-based API for manually controlling the generated temperature values.

Both scripts can downloaded from [BSCW](https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44039504/Device%20Simulators.tar).

To run the scripts as services, under Ubuntu, upstart scripts can be exploited. Below are reported the two scripts used on the demonstration machine, they shall be placed in the ```/etc/init``` folder and given the right permissions (look at the other files in the same folder)

#### xively-bin service
The file is named ```xively-bin.conf``` and its content is as follows:

```
description "fake bin sensors on xively"
author      "dario bonino"

start on started networking
stop on stopped networking

#wait 5s before respawning
post-stop exec sleep 5

# Automatically Respawn:
respawn
respawn limit 99 5

script
export HOME="/home/almanac"

cd /opt/python-services/almanac-y1-demo-filllevel-xively/
exec  sudo -u almanac python filllevel_simulator_xively.py  >> /var/log/xively/xively-bin.log 2>&1
end script

post-start script
# Optionally put a script here that will notifiy you node has (re)started
# /root/bin/hoptoad.sh "node.js has started!"
end script
```

#### xively-t service
The file is named ```xively-t.con``` and its content is reported below:

```
description "fake temperature sensors on xively"
author      "dario bonino"

start on started networking
stop on stopped networking

#sleep 5 seconds between restarts
post-stop exec sleep 5

# Automatically Respawn:
respawn
respawn limit 99 5

script
# Not sure why $HOME is needed, but we found that it is:
export HOME="/home/almanac"

cd /opt/python-services/almanac-y1-demo-temperature-xively
exec  sudo -u almanac python temperature_simulator_xively.py  >> /var/log/xively/xively-t.log 2>&1
end script

post-start script
# Optionally put a script here that will notifiy you node has (re)started
# /root/bin/hoptoad.sh "node.js has started!"
end script
```
#### Diagnosis scripts
Currently one of the crucial point in understanding whether the SCRAL is correctly sending events to any "listening" platform component is to check is such events are published correctly on the platform instance MQTT broker. This can easily be achieved through the ```mosquitto_dump``` support script provided with the SCRAL (and available on [BSCW](https://fit-bscw.fit.fraunhofer.de/bscw/bscw.cgi/d44039520/The%20MQTT%20diagnostic%20tool))

To check whether the SCRAL is sending data on a given topic (or tree of topics), e.g., /federation1/v2/#, on a given broker, e.g., almanac-showcase.ismb.it, listening on a given port, e.g., 1883, it is sufficient to run the script with following parameters:

```
mosquitto_dump.py -h almanac-showcase.ismb.it -p 1883 -t /federation1/v2/#
```

The messages delivered by the broker, on the given topic, will be shown on the console.

## Notice / Disclaimer
All python scripts might depend on libraries and modules not available by default on the target machine. In such a case just install missing modules through the available Python tool chain, i.e., ```easy_install``` or ```pip```.